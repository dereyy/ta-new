{% extends "base.html" %}

{% block title %}Hasil Analisis GLOD - GLOD Community Detector{% endblock %}
{% block extra_head %}
<style>
.page-title {
  font-size: 2rem;
  color: #1976d2;
  font-weight: 900;
  text-align: center;
  letter-spacing: 0.5px;
  margin-bottom: 25px;
}
.section-heading {
  color: #1976d2;
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 13px;
}
</style>
{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-center align-items-center mb-3">
    <h3 class="mb-0 page-title">Hasil Deteksi Komunitas</h3>
  </div>

  {% if error %}
  <div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i> {{ error }} 
    {% if error_detail %}
    <details class="mt-2">
      <summary>Detail Error</summary>
      <pre class="mt-2">{{ error_detail }}</pre>
    </details>
    {% endif %}
  </div>
  {% else %}
  <div class="row mb-4 g-3">

    <!-- Jumlah Komunitas -->
    <div class="col-md-3">
      <div class="card bg-primary text-white h-100 shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title">Jumlah Komunitas</h6>
          <h2 class="mb-0">{{ num_communities }}</h2>
        </div>
      </div>
    </div>

    <!-- Normalized Node Cut -->
    <div class="col-md-3">
      <div class="card bg-info text-white h-100 shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title">Normalized Node Cut (Ψ)</h6>
          <h2 class="mb-0">{{ avg_psi_node_cut }}</h2>
        </div>
      </div>
    </div>

    <!-- Total Nodes -->
    <div class="col-md-3">
      <div class="card bg-info text-white h-100 shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title">Total Nodes</h6>
          <h2 class="mb-0">{{ total_nodes }}</h2>
        </div>
      </div>
    </div>

    <!-- Total Edges -->
    <div class="col-md-3">
      <div class="card bg-info text-white h-100 shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title">Total Edges</h6>
          <h2 class="mb-0">{{ total_edges }}</h2>
        </div>
      </div>
    </div>

  </div>


  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title section-heading">Parameter yang Digunakan</h5>
      <div class="row">
        
          <p class="mb-1">α (Alpha)     :{{ alpha }}</p>
      
          <p class="mb-1">Threshold Jaccard : {{ jaccard_threshold }}</p>
       
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Visualisasi Jaringan dengan Komunitas</h5>
    </div>
    <div class="card-body">
      <div id="network-container" style="height: 700px; border: 1px solid #ddd"></div>

      <div class="mt-3">
        <button class="btn btn-success" onclick="downloadVisualization()">
          <i class="fas fa-download"></i> Download Visualisasi PNG
        </button>
        <div class="btn-group" role="group">
          <button class="btn btn-info" onclick="downloadCommunityData('csv')">
            <i class="fas fa-file-csv"></i> Download CSV
          </button>
          <button class="btn btn-info" onclick="downloadCommunityData('xlsx')">
            <i class="fas fa-file-excel"></i> Download XLSX
          </button>
        </div>
        </button>
      </div>

      <div class="mt-3">
        <h6>Legend Warna Komunitas:</h6>
        <div class="d-flex flex-wrap">
          {% for color in color_palette %}
          <div class="me-3 mb-2">
            <span class="badge" style="background-color: {{ color }}; color: white; padding: 8px 12px;">
              Komunitas {{ forloop.counter }}
            </span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Detail Komunitas</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Komunitas ID</th>
              <th>Jumlah Anggota</th>
              <th>Jumlah Overlap</th>
              <th>Anggota Protein</th>
              <th>Protein Overlap</th>
              <th>Normalized Node Cut (Ψ)</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            {% for community in communities %}
            <tr id="community-row-{{ community.id }}">
              <td>
                <span class="badge" style="background-color: #000000; color: white; font-size: 14px; padding: 6px 10px;">
                  Komunitas {{ community.id }}
                </span>
              </td>
              <td><strong>{{ community.size }}</strong></td>
              <td><strong>{{ community.overlap_count }}</strong></td>
              <td>
                <details>
                  <summary>Lihat {{ community.size }} anggota</summary>
                  <div class="mt-2" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
                    {% for member in community.members %}
                    <span class="badge bg-secondary me-1 mb-1">{{ member }}</span>
                    {% endfor %}
                  </div>
                </details>
              </td>
              <td>
                {% if community.overlap_count > 0 %}
                <details>
                  <summary>Lihat {{ community.overlap_count }} overlap</summary>
                  <div class="mt-2" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
                    {% for member in community.overlap_members %}
                    <span class="badge bg-warning text-dark me-1 mb-1">{{ member }}</span>
                    {% endfor %}
                  </div>
                </details>
                {% else %}
                <span class="badge bg-success">Tidak ada overlap</span>
                {% endif %}
              </td>
              <td>
                <span class="badge bg-info text-white" style="font-size: 14px; padding: 6px 10px;">
                  {{ community.psi }}
                </span>
              </td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="toggleCommunityVisualization({{ community.id }})">
                  <i class="fas fa-chart-network"></i> Tampilkan Komunitas
                </button>
              </td>
            </tr>
            <tr id="visualization-row-{{ community.id }}" style="display: none;">
              <td colspan="7">
                <div style="padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
                  <div style="margin-bottom: 10px;">
                    <strong>Visualisasi Komunitas {{ community.id }}</strong>
                    <button class="btn btn-sm btn-secondary float-end" onclick="toggleCommunityVisualization({{ community.id }})">
                      <i class="fas fa-times"></i> Sembunyikan
                    </button>
                  </div>
                  <div id="community-network-container-{{ community.id }}" style="height: 400px; border: 1px solid #ddd; border-radius: 4px;"></div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Statistik Komunitas</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <canvas id="communitySizeChart"></canvas>
        </div>
        <div class="col-md-6">
          <h6>Ringkasan Statistik</h6>
          <table class="table table-sm">
            <tr>
              <td>Ukuran Komunitas Terbesar:</td>
              <td><strong id="max-size">-</strong></td>
            </tr>
            <tr>
              <td>Ukuran Komunitas Terkecil:</td>
              <td><strong id="min-size">-</strong></td>
            </tr>
            <tr>
              <td>Rata-rata Ukuran Komunitas:</td>
              <td><strong id="avg-size">-</strong></td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>

  {% endif %}
</div>

{% if not error %}
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
  // Parse data dari Django
  const visNodes = {{ vis_nodes|safe }};
  const visEdges = {{ vis_edges|safe }};
  const communities = {{ communities|safe }};
  const colorPalette = {{ color_palette|safe }};

  // Filter nodes: hanya tampilkan node yang ada di komunitas (communities.length > 0)
  const nodesInCommunities = visNodes.filter(node => node.communities.length > 0);
  const communityNodeIds = new Set(nodesInCommunities.map(node => node.id));

  // Buat DataSet untuk vis.js
  const nodes = new vis.DataSet(nodesInCommunities.map(node => {
    // Deteksi apakah node adalah overlap (ada di lebih dari 1 komunitas)
    const isOverlapping = node.communities.length > 1;
    
    if (isOverlapping) {
      // Node overlap: outline saja dengan border hitam tebal
      return {
        id: node.id,
        label: node.label,
        title: node.title,
        color: {
          background: 'rgba(255, 255, 255, 0)',  // Transparent background
          border: '#2B7CE9',                      // Black border
        },
        borderWidth: 4,
        font: {
          size: 12,
          color: '#000'
        },
        communities: node.communities
      };
    } else {
      // Node biasa: fill penuh dengan warna komunitas
      return {
        id: node.id,
        label: node.label,
        title: node.title,
        color: {
          background: node.color,
          border: '#2B7CE9',
          highlight: {
            background: node.color,
            border: '#000000'
          }
        },
        font: {
          size: 12,
          color: '#000'
        },
        communities: node.communities
      };
    }
  }));

  // Filter edges: hanya tampilkan edge yang kedua ujungnya ada di komunitas
  const edges = new vis.DataSet(visEdges.filter(edge => 
    communityNodeIds.has(edge.from) && communityNodeIds.has(edge.to)
  ).map(edge => ({
    from: edge.from,
    to: edge.to,
    color: {
      color: '#cccccc',
      highlight: '#000000'
    },
    width: 2
  })));

  // Konfigurasi network
  const options = {
    physics: {
      enabled: true,
      stabilization: {
        iterations: 200,
        updateInterval: 50
      },
      barnesHut: {
        gravitationalConstant: -3000,
        centralGravity: 0.3,
        springLength: 150,
        springConstant: 0.04,
        damping: 0.95,
        avoidOverlap: 0.5
      }
    },
    nodes: {
      shape: 'dot',
      size: 20,
      borderWidth: 2,
      font: {
        size: 12,
        face: 'Arial'
      }
    },
    edges: {
      width: 2,
      smooth: {
        type: 'continuous'
      }
    },
    interaction: {
      hover: true,
      tooltipDelay: 100,
      zoomView: true,
      dragView: true
    }
  };

  const container = document.getElementById('network-container');
  const network = new vis.Network(container, { nodes: nodes, edges: edges }, options);

  // Stabilization callback
  network.on("stabilizationIterationsDone", function() {
    network.setOptions({ physics: { enabled: false } });
    network.fit();
  });

  // Download visualization
  function downloadVisualization() {
    const canvas = document.querySelector('#network-container canvas');
    if (canvas) {
      const link = document.createElement('a');
      link.download = 'glod-communities-' + new Date().getTime() + '.png';
      link.href = canvas.toDataURL('image/png', 1.0);
      link.click();
    }
  }

  // Download community data as Excel
  function downloadCommunityData() {
    if (typeof XLSX === 'undefined') {
      alert('Library XLSX belum dimuat.');
      return;
    }

    const data = communities.map(comm => ({
      'Komunitas ID': comm.id,
      'Jumlah Anggota': comm.size,
      'Anggota': comm.members.join(', ')
    }));

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);

    ws['!cols'] = [
      { width: 15 },
      { width: 15 },
      { width: 100 }
    ];

    XLSX.utils.book_append_sheet(wb, ws, "Communities");

    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    const filename = `glod-communities-${timestamp}.xlsx`;

    XLSX.writeFile(wb, filename);
  }

  // Chart untuk ukuran komunitas
  const ctx = document.getElementById('communitySizeChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: communities.map(c => 'C' + c.id),
      datasets: [{
        label: 'Ukuran Komunitas',
        data: communities.map(c => c.size),
        backgroundColor: colorPalette,
        borderColor: colorPalette.map(c => c),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Distribusi Ukuran Komunitas'
        },
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Jumlah Node'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Komunitas'
          }
        }
      }
    }
  });

  // Hitung statistik komunitas
  const communitySizes = communities.map(c => c.size);
  const totalSize = communitySizes.reduce((sum, size) => sum + size, 0);
  const avgSize = (totalSize / communities.length).toFixed(2);
  const maxSize = Math.max(...communitySizes);
  const minSize = Math.min(...communitySizes);

  document.getElementById('avg-size').textContent = avgSize;
  document.getElementById('max-size').textContent = maxSize;
  document.getElementById('min-size').textContent = minSize;

  // Fungsi download data komunitas
  function downloadCommunityData(format = 'csv') {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "download_community_data" %}';
    
    // Tambahkan CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
      form.appendChild(csrfToken.cloneNode(true));
    }
    
    // Tambahkan format
    const formatInput = document.createElement('input');
    formatInput.type = 'hidden';
    formatInput.name = 'format';
    formatInput.value = format;
    form.appendChild(formatInput);
    
    // Tambahkan data komunitas
    const communitiesInput = document.createElement('input');
    communitiesInput.type = 'hidden';
    communitiesInput.name = 'communities_json';
    communitiesInput.value = JSON.stringify(communities);
    form.appendChild(communitiesInput);
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
  }

  // Fungsi download visualisasi (stub untuk sekarang)
  function downloadVisualization() {
    alert('Fitur download visualisasi PNG belum diimplementasikan');
  }

  // Menyimpan network instances untuk setiap komunitas
  const communityNetworks = {};

  // Fungsi untuk toggle visualisasi komunitas
  function toggleCommunityVisualization(communityId) {
    const visualizationRow = document.getElementById(`visualization-row-${communityId}`);
    const container = document.getElementById(`community-network-container-${communityId}`);
    
    if (visualizationRow.style.display === 'none') {
      visualizationRow.style.display = 'table-row';
      
      // Jika belum di-render, render sekarang
      if (!communityNetworks[communityId]) {
        renderCommunityNetwork(communityId, container);
      } else {
        // Jika sudah ada, refresh ukuran container
        setTimeout(() => {
          communityNetworks[communityId].fit();
        }, 100);
      }
    } else {
      visualizationRow.style.display = 'none';
    }
  }

  // Fungsi untuk render jaringan komunitas
  function renderCommunityNetwork(communityId, container) {
    // Filter nodes dan edges yang termasuk komunitas ini
    const communityNodes = visNodes.filter(node => node.communities.includes(communityId));
    const communityNodeIds = new Set(communityNodes.map(node => node.id));
    const communityEdges = visEdges.filter(edge => 
      communityNodeIds.has(edge.from) && communityNodeIds.has(edge.to)
    );

    // Buat DataSet untuk komunitas ini
    const commNodes = new vis.DataSet(communityNodes.map(node => {
      // Deteksi apakah node adalah overlap (ada di lebih dari 1 komunitas)
      const isOverlapping = node.communities.length > 1;
      
      if (isOverlapping) {
        // Node overlap: outline saja dengan border hitam tebal
        return {
          id: node.id,
          label: node.label,
          title: node.label,
          color: {
            background: 'rgba(255, 255, 255, 0)',  // Transparent background
            border: '#2B7CE9',                      // Black border
          },
          borderWidth: 4,
          font: {
            size: 14,
            color: '#000',
            bold: { color: '#000' }
          }
        };
      } else {
        // Node biasa: fill penuh dengan warna komunitas
        return {
          id: node.id,
          label: node.label,
          title: node.label,
          color: {
            background: node.color,
            border: '#2B7CE9',
            highlight: {
              background: node.color,
              border: '#000000'
            }
          },
          font: {
            size: 14,
            color: '#000',
            bold: { color: '#000' }
          }
        };
      }
    }));

    const commEdges = new vis.DataSet(communityEdges.map(edge => ({
      from: edge.from,
      to: edge.to,
      color: {
        color: '#999999',
        highlight: '#000000'
      },
      width: 2
    })));

    // Konfigurasi untuk komunitas network
    const options = {
      physics: {
        enabled: true,
        stabilization: {
          iterations: 200,
          updateInterval: 50
        },
        barnesHut: {
          gravitationalConstant: -3000,
          centralGravity: 0.3,
          springLength: 150,
          springConstant: 0.04,
          damping: 0.95,
          avoidOverlap: 0.5
        }
      },
      nodes: {
        shape: 'dot',
        size: 25,
        borderWidth: 2,
        font: {
          size: 14,
          face: 'Arial'
        }
      },
      edges: {
        width: 2,
        smooth: {
          type: 'continuous',
          forceDirection: 'none',
          roundness: 0.5
        }
      },
      interaction: {
        hover: true,
        zoomView: true,
        dragView: true
      },
      configure: false
    };

    // Render network
    const data = { nodes: commNodes, edges: commEdges };
    communityNetworks[communityId] = new vis.Network(container, data, options);
    
    // Stabilization callback: disable physics setelah stabil
    communityNetworks[communityId].on("stabilizationIterationsDone", function() {
      communityNetworks[communityId].setOptions({ physics: { enabled: false } });
      communityNetworks[communityId].fit();
    });
  }
</script>
{% endif %} 
{% endblock %}
