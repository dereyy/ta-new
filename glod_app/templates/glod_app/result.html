{% extends "base.html" %}

{% block title %}Hasil Analisis GLOD - GLOD Community Detector{% endblock %}
{% block extra_head %}
<style>
.page-title {
  font-size: 2rem;
  color: #1976d2;
  font-weight: 900;
  text-align: center;
  letter-spacing: 0.5px;
  margin-bottom: 25px;
}
.section-heading {
  color: #1976d2;
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 13px;
}
</style>
{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-center align-items-center mb-3">
    <h3 class="mb-0 page-title">Hasil Deteksi Komunitas</h3>
  </div>

  {% if error %}
  <div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i> {{ error }} 
    {% if error_detail %}
    <details class="mt-2">
      <summary>Detail Error</summary>
      <pre class="mt-2">{{ error_detail }}</pre>
    </details>
    {% endif %}
  </div>
  {% else %}
  <div class="row mb-4 g-3">

    <!-- Jumlah Komunitas -->
    <div class="col-md-3">
      <div class="card bg-primary text-white h-100 shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title">Jumlah Komunitas</h6>
          <h2 class="mb-0">{{ num_communities }}</h2>
        </div>
      </div>
    </div>

    <!-- Normalized Node Cut -->
    <div class="col-md-3">
      <div class="card bg-info text-white h-100 shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title">Normalized Node Cut (Ψ)</h6>
          <h2 class="mb-0">{{ avg_psi_node_cut }}</h2>
        </div>
      </div>
    </div>

    <!-- Total Nodes -->
    <div class="col-md-3">
      <div class="card bg-info text-white h-100 shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title">Total Nodes</h6>
          <h2 class="mb-0">{{ total_nodes }}</h2>
        </div>
      </div>
    </div>

    <!-- Total Edges -->
    <div class="col-md-3">
      <div class="card bg-info text-white h-100 shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title">Total Edges</h6>
          <h2 class="mb-0">{{ total_edges }}</h2>
        </div>
      </div>
    </div>

  </div>


  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title section-heading">Parameter yang Digunakan</h5>
      <div class="row">
        
          <p class="mb-1">α (Alpha)     :{{ alpha }}</p>
      
          <p class="mb-1">Threshold Jaccard : {{ jaccard_threshold }}</p>
       
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Visualisasi Jaringan dengan Komunitas</h5>
    </div>
    <div class="card-body">
      <div id="network-container" style="height: 700px; border: 1px solid #ddd"></div>

      <div class="mt-3">
        <button class="btn btn-success" onclick="downloadVisualization()">
          <i class="fas fa-download"></i> Download Visualisasi PNG
        </button>
        <div class="btn-group" role="group">
          <button class="btn btn-info" onclick="downloadCommunityData('csv')">
            <i class="fas fa-file-csv"></i> Download CSV
          </button>
          <button class="btn btn-info" onclick="downloadCommunityData('xlsx')">
            <i class="fas fa-file-excel"></i> Download XLSX
          </button>
        </div>
        </button>
      </div>

      <div class="mt-3">
        <h6>Legend Warna Komunitas:</h6>
        <div class="d-flex flex-wrap" id="legend-container"></div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Detail Komunitas</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Komunitas ID</th>
              <th>Jumlah Anggota</th>
              <th>Jumlah Overlap</th>
              <th>Anggota Protein</th>
              <th>Protein Overlap</th>
              <th>Normalized Node Cut (Ψ)</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            {% for community in communities %}
            <tr id="community-row-{{ community.id }}">
              <td>
                <span class="badge" style="background-color: #000000; color: white; font-size: 14px; padding: 6px 10px;">
                  Komunitas {{ community.id }}
                </span>
              </td>
              <td><strong>{{ community.size }}</strong></td>
              <td><strong>{{ community.overlap_count }}</strong></td>
              <td>
                <details>
                  <summary>Lihat {{ community.size }} anggota</summary>
                  <div class="mt-2" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
                    {% for member in community.members %}
                    <span class="badge bg-secondary me-1 mb-1">{{ member }}</span>
                    {% endfor %}
                  </div>
                </details>
              </td>
              <td>
                {% if community.overlap_count > 0 %}
                <details>
                  <summary>Lihat {{ community.overlap_count }} overlap</summary>
                  <div class="mt-2" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; border-radius: 4px;">
                    {% for member in community.overlap_members %}
                    <span class="badge bg-warning text-dark me-1 mb-1">{{ member }}</span>
                    {% endfor %}
                  </div>
                </details>
                {% else %}
                <span class="badge bg-success">Tidak ada overlap</span>
                {% endif %}
              </td>
              <td>
                <span class="badge bg-info text-white" style="font-size: 14px; padding: 6px 10px;">
                  {{ community.psi }}
                </span>
              </td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="toggleCommunityVisualization({{ community.id }})">
                  <i class="fas fa-chart-network"></i> Tampilkan Komunitas
                </button>
              </td>
            </tr>
            <tr id="visualization-row-{{ community.id }}" style="display: none;">
              <td colspan="7">
                <div style="padding: 15px; background-color: #f8f9fa; border-radius: 4px;">
                  <div style="margin-bottom: 10px;">
                    <strong>Visualisasi Komunitas {{ community.id }}</strong>
                    <button class="btn btn-sm btn-secondary float-end" onclick="toggleCommunityVisualization({{ community.id }})">
                      <i class="fas fa-times"></i> Sembunyikan
                    </button>
                  </div>
                  <div id="community-network-container-{{ community.id }}" style="height: 400px; border: 1px solid #ddd; border-radius: 4px;"></div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Statistik Komunitas</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <canvas id="communitySizeChart"></canvas>
        </div>
        <div class="col-md-6">
          <h6>Ringkasan Statistik</h6>
          <table class="table table-sm">
            <tr>
              <td>Ukuran Komunitas Terbesar:</td>
              <td><strong id="max-size">-</strong></td>
            </tr>
            <tr>
              <td>Ukuran Komunitas Terkecil:</td>
              <td><strong id="min-size">-</strong></td>
            </tr>
            <tr>
              <td>Rata-rata Ukuran Komunitas:</td>
              <td><strong id="avg-size">-</strong></td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>

  {% endif %}
</div>

{% if not error %}
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
  // Parse data dari Django
  const visNodes = {{ vis_nodes|safe }};
  const visEdges = {{ vis_edges|safe }};
  const communities = {{ communities|safe }};
  const colorPalette = {{ color_palette|safe }};

  function showNetworkFatalError(err) {
    const container = document.getElementById('network-container');
    if (!container) return;
    const message = (err && (err.stack || err.message)) ? (err.stack || err.message) : String(err);
    container.innerHTML = `
      <div style="padding:12px; color:#b00020; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; white-space: pre-wrap;">
        <strong>Network error</strong>\n${message}
      </div>`;
  }

  window.addEventListener('error', (e) => {
    showNetworkFatalError(e.error || e.message);
  });
  window.addEventListener('unhandledrejection', (e) => {
    showNetworkFatalError(e.reason);
  });

  function normalizeCommunities(value) {
    if (Array.isArray(value)) return value;
    if (value === null || value === undefined) return [];
    if (typeof value === 'string') {
      const trimmed = value.trim();
      if (!trimmed) return [];
      try {
        const parsed = JSON.parse(trimmed);
        if (Array.isArray(parsed)) return parsed;
      } catch (_) {
        // ignore
      }
      return trimmed.split(',').map(s => s.trim()).filter(Boolean);
    }
    return [value];
  }

  // Filter nodes: hanya tampilkan node yang ada di komunitas (communities.length > 0)
  const nodesInCommunities = visNodes
    .map(n => ({ ...n, communities: normalizeCommunities(n.communities) }))
    .filter(node => node.communities.length > 0);

  if (nodesInCommunities.length === 0) {
    showNetworkFatalError('Tidak ada node dengan komunitas (vis_nodes[*].communities kosong / format tidak sesuai).');
  }
  const communityNodeIds = new Set(nodesInCommunities.map(node => node.id));

  // Buat mapping warna komunitas dengan logika yang sama seperti legend
  const communityColors = {};
  communities.forEach((comm, idx) => {
    let color;
    if (idx < colorPalette.length) {
      color = colorPalette[idx];
    } else {
      // Generate warna dinamis menggunakan HSL untuk komunitas tambahan
      const hue = (idx * 360 / Math.max(colorPalette.length, communities.length)) % 360;
      color = `hsl(${hue}, 70%, 50%)`;
    }
    communityColors[comm.id] = color;
  });

  // Custom renderer untuk node dengan multiple rings
  function renderNode(ctx, x, y, nodeData) {
    const { size, label, communities } = nodeData;
    const numCommunities = communities.length;
    const ringWidth = 4;
    
    try {
      // Gambar background putih
      ctx.save();
      ctx.fillStyle = 'white';
      ctx.beginPath();
      ctx.arc(x, y, size, 0, 2 * Math.PI);
      ctx.fill();
      
      // Gambar rings untuk setiap komunitas (dari luar ke dalam)
      for (let i = 0; i < numCommunities; i++) {
        const commId = communities[i];
        const color = communityColors[commId] || colorPalette[commId % colorPalette.length];
        const radius = size - (i * ringWidth);
        
        if (radius > 5) {
          ctx.strokeStyle = color;
          ctx.lineWidth = ringWidth;
          ctx.beginPath();
          ctx.arc(x, y, radius - ringWidth / 2, 0, 2 * Math.PI);
          ctx.stroke();
        }
      }
      
      // Gambar label di tengah
      ctx.fillStyle = '#000';
      ctx.font = 'bold 9px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(label, x, y);
      ctx.restore();
      
      return true; // Return true untuk mengindikasikan rendering berhasil
    } catch (error) {
      console.error('Error rendering node:', label, error);
      return false;
    }
  }

  // Hitung ukuran setiap komunitas
  // NOTE: pakai nama berbeda agar tidak bentrok dengan variabel chart di bawah.
  const communitySizeById = {};
  nodesInCommunities.forEach(node => {
    node.communities.forEach(commId => {
      communitySizeById[commId] = (communitySizeById[commId] || 0) + 1;
    });
  });

  console.log('Community sizes:', communitySizeById);

  // --- Community anchors ---
  // Supaya komunitas tidak bercampur, kita buat "anchor" (node tak terlihat) untuk tiap komunitas
  // dengan posisi tetap. Semua node di komunitas itu dihubungkan ke anchornya via edge physics.
  const nodeCommunitiesById = new Map(nodesInCommunities.map(n => [n.id, n.communities]));
  const communityIdList = Object.keys(communitySizeById)
    .map(id => (typeof id === 'string' && /^\d+$/.test(id)) ? Number(id) : id)
    .sort((a, b) => (a > b ? 1 : a < b ? -1 : 0));
  const commSizes = communityIdList.map(id => communitySizeById[id] || 0);
  const maxCommSize = Math.max(...commSizes, 1);
  const minCommSize = Math.min(...commSizes, 0);

  function clamp(n, lo, hi) { return Math.max(lo, Math.min(hi, n)); }
  function anchorRadiusForSize(size) {
    // Komunitas kecil -> radius lebih besar (pinggir)
    const denom = (maxCommSize - minCommSize) || 1;
    const t = clamp((maxCommSize - size) / denom, 0, 1);
    return 1200 + (t * 2200); // 1200..3400 (lebih jauh supaya tidak bercampur)
  }

  const anchorNodes = communityIdList.map((commId, i) => {
    const angle = (i * 2 * Math.PI) / Math.max(communityIdList.length, 1);
    const radius = anchorRadiusForSize(communitySizeById[commId] || 0);
    return {
      id: `anchor_${commId}`,
      label: '',
      shape: 'dot',
      size: 1,
      hidden: true,
      physics: false,
      fixed: { x: true, y: true },
      x: Math.cos(angle) * radius,
      y: Math.sin(angle) * radius
    };
  });

  // Buat DataSet untuk vis.js (node asli)
  const nodeItems = nodesInCommunities.map((node) => {
    const numCommunities = node.communities.length;
    const nodeSize = 20 + (numCommunities * 4);
    const primaryCommunity = node.communities[0];
    const isOverlap = numCommunities > 1;

    return {
      id: node.id,
      label: node.label,
      title: node.title,
      shape: 'custom',
      size: nodeSize,
      communities: node.communities,
      group: primaryCommunity,
      mass: isOverlap ? 6 : 1,
      ctxRenderer: function(params) {
        const {ctx, x, y, state, style} = params;

        const result = renderNode(ctx, x, y, {
          size: style.size,
          label: node.label,
          communities: node.communities
        });

        if (state.selected || state.hover) {
          ctx.strokeStyle = state.selected ? '#FF0000' : '#666666';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(x, y, style.size + 3, 0, 2 * Math.PI);
          ctx.stroke();
        }

        return result;
      },
      font: {
        size: 9,
        color: '#000'
      }
    };
  });

  const nodes = new vis.DataSet([...anchorNodes, ...nodeItems]);

  console.log('Nodes created:', nodes.length, 'from', nodesInCommunities.length, 'nodes in communities');

  function sharesCommunity(a, b) {
    if (!a || !b) return false;
    // cek intersection sederhana
    for (let i = 0; i < a.length; i++) {
      if (b.includes(a[i])) return true;
    }
    return false;
  }

  // Filter edges: hanya tampilkan edge yang kedua ujungnya ada di komunitas
  const graphEdgeItems = visEdges.filter(edge =>
    communityNodeIds.has(edge.from) && communityNodeIds.has(edge.to)
  ).map(edge => {
    const fromComms = nodeCommunitiesById.get(edge.from);
    const toComms = nodeCommunitiesById.get(edge.to);
    const sameCommunity = sharesCommunity(fromComms, toComms);

    return {
      from: edge.from,
      to: edge.to,
      color: {
        color: '#1566c1',
        highlight: '#000000',
        opacity: sameCommunity ? 0.55 : 0.18
      },
      width: sameCommunity ? 3.5 : 2.2,
      length: sameCommunity ? 80 : 900,
      // Edge asli hanya untuk visual, physics dikendalikan oleh anchor edges
      physics: false
    };
  });

  // Edge anchor (tak terlihat) untuk memaksa node tetap di area komunitasnya
  const anchorEdgeItems = [];
  nodesInCommunities.forEach(node => {
    const comms = node.communities;
    const isOverlap = comms.length > 1;

    // Non-overlap node: kunci kuat ke anchor utama
    if (!isOverlap) {
      const commId = comms[0];
      anchorEdgeItems.push({
        from: `anchor_${commId}`,
        to: node.id,
        length: 35,
        width: 0.1,
        color: { color: 'rgba(0,0,0,0)', opacity: 0 },
        smooth: false,
        physics: true
      });
      return;
    }

    // Overlap node: hubungkan ke semua anchor tapi lebih longgar
    // supaya node overlap berada di antara komunitas tanpa menarik komunitas menjadi bercampur.
    for (let i = 0; i < comms.length; i++) {
      const commId = comms[i];
      anchorEdgeItems.push({
        from: `anchor_${commId}`,
        to: node.id,
        length: 260,
        width: 0.1,
        color: { color: 'rgba(0,0,0,0)', opacity: 0 },
        smooth: false,
        physics: true
      });
    }
  });

  const edges = new vis.DataSet([...graphEdgeItems, ...anchorEdgeItems]);

  // Konfigurasi network: komunitas dipisah oleh anchor + physics moderat
  const options = {
    physics: {
      enabled: true,
      stabilization: {
        iterations: 900,
        updateInterval: 25,
        fit: true
      },
      barnesHut: {
        gravitationalConstant: -12000,
        centralGravity: 0.02,
        springLength: 110,
        springConstant: 0.08,
        damping: 0.4,
        avoidOverlap: 1
      }
    },
    nodes: {
      shape: 'dot',
      size: 20,
      borderWidth: 2,
      font: {
        size: 10,
        face: 'Arial',
        align: 'center',
        vadjust: 0
      }
    },
    edges: {
      width: 1,
      color: {
        color: '#cccccc',
        opacity: 0.3
      },
      smooth: {
        type: 'continuous',
        forceDirection: 'none'
      }
    },
    groups: {
      useDefaultGroups: false
    },
    interaction: {
      hover: true,
      tooltipDelay: 100,
      zoomView: true,
      dragView: true
    },
    layout: {
      improvedLayout: true,
      clusterThreshold: 150
    }
  };

  const container = document.getElementById('network-container');
  const network = new vis.Network(container, { nodes: nodes, edges: edges }, options);

  console.log('Total nodes in dataset:', nodes.length);
  console.log('Total edges in dataset:', edges.length);

  // Stabilization callback
  network.on("stabilizationIterationsDone", function() {
    console.log('Stabilization done');
    network.setOptions({ physics: { enabled: false } });
    network.fit();
  });

  // Debug: cek apakah semua nodes di-render
  network.on("afterDrawing", function() {
    try {
      if (typeof network.getVisibleNodes === 'function') {
        console.log('Network drawn, visible nodes:', network.getVisibleNodes().length);
      } else {
        console.log('Network drawn');
      }
    } catch (e) {
      console.log('Network drawn (debug error ignored):', e);
    }
  });

  // Download visualization
  function downloadVisualization() {
    const canvas = document.querySelector('#network-container canvas');
    if (canvas) {
      const link = document.createElement('a');
      link.download = 'glod-communities-' + new Date().getTime() + '.png';
      link.href = canvas.toDataURL('image/png', 1.0);
      link.click();
    }
  }

  // Download community data as Excel
  function downloadCommunityData() {
    if (typeof XLSX === 'undefined') {
      alert('Library XLSX belum dimuat.');
      return;
    }

    const data = communities.map(comm => ({
      'Komunitas ID': comm.id,
      'Jumlah Anggota': comm.size,
      'Anggota': comm.members.join(', ')
    }));

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);

    ws['!cols'] = [
      { width: 15 },
      { width: 15 },
      { width: 100 }
    ];

    XLSX.utils.book_append_sheet(wb, ws, "Communities");

    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    const filename = `glod-communities-${timestamp}.xlsx`;

    XLSX.writeFile(wb, filename);
  }

  // Chart untuk ukuran komunitas
  const ctx = document.getElementById('communitySizeChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: communities.map(c => 'C' + c.id),
      datasets: [{
        label: 'Ukuran Komunitas',
        data: communities.map(c => c.size),
        backgroundColor: colorPalette,
        borderColor: colorPalette.map(c => c),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Distribusi Ukuran Komunitas'
        },
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Jumlah Node'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Komunitas'
          }
        }
      }
    }
  });

  // Hitung statistik komunitas
  const communitySizes = communities.map(c => c.size);
  const totalSize = communitySizes.reduce((sum, size) => sum + size, 0);
  const avgSize = (totalSize / communities.length).toFixed(2);
  const maxSize = Math.max(...communitySizes);
  const minSize = Math.min(...communitySizes);

  document.getElementById('avg-size').textContent = avgSize;
  document.getElementById('max-size').textContent = maxSize;
  document.getElementById('min-size').textContent = minSize;

  // Generate legend warna komunitas
  const legendContainer = document.getElementById('legend-container');
  communities.forEach((community, index) => {
    // Jika ada komunitas lebih banyak dari colorPalette, generate warna dinamis
    let color;
    if (index < colorPalette.length) {
      color = colorPalette[index];
    } else {
      // Generate warna dinamis menggunakan HSL untuk komunitas tambahan
      const hue = (index * 360 / Math.max(colorPalette.length, communities.length)) % 360;
      color = `hsl(${hue}, 70%, 50%)`;
    }
    
    const legendItem = document.createElement('div');
    legendItem.className = 'me-3 mb-2';
    legendItem.innerHTML = `<span class="badge" style="background-color: ${color}; color: white; padding: 8px 12px;">Komunitas ${community.id}</span>`;
    legendContainer.appendChild(legendItem);
  });

  // Fungsi download data komunitas
  function downloadCommunityData(format = 'csv') {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "download_community_data" %}';
    
    // Tambahkan CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
      form.appendChild(csrfToken.cloneNode(true));
    }
    
    // Tambahkan format
    const formatInput = document.createElement('input');
    formatInput.type = 'hidden';
    formatInput.name = 'format';
    formatInput.value = format;
    form.appendChild(formatInput);
    
    // Tambahkan data komunitas
    const communitiesInput = document.createElement('input');
    communitiesInput.type = 'hidden';
    communitiesInput.name = 'communities_json';
    communitiesInput.value = JSON.stringify(communities);
    form.appendChild(communitiesInput);
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
  }

  // Fungsi download visualisasi (stub untuk sekarang)
  function downloadVisualization() {
    alert('Fitur download visualisasi PNG belum diimplementasikan');
  }

  // Menyimpan network instances untuk setiap komunitas
  const communityNetworks = {};

  // Fungsi untuk toggle visualisasi komunitas
  function toggleCommunityVisualization(communityId) {
    const visualizationRow = document.getElementById(`visualization-row-${communityId}`);
    const container = document.getElementById(`community-network-container-${communityId}`);
    
    if (visualizationRow.style.display === 'none') {
      visualizationRow.style.display = 'table-row';
      
      // Jika belum di-render, render sekarang
      if (!communityNetworks[communityId]) {
        renderCommunityNetwork(communityId, container);
      } else {
        // Jika sudah ada, refresh ukuran container
        setTimeout(() => {
          communityNetworks[communityId].fit();
        }, 100);
      }
    } else {
      visualizationRow.style.display = 'none';
    }
  }

  // Fungsi untuk render jaringan komunitas
  function renderCommunityNetwork(communityId, container) {
    // Filter nodes dan edges yang termasuk komunitas ini
    const communityNodes = visNodes.filter(node => node.communities.includes(communityId));
    const communityNodeIds = new Set(communityNodes.map(node => node.id));
    const communityEdges = visEdges.filter(edge => 
      communityNodeIds.has(edge.from) && communityNodeIds.has(edge.to)
    );

    // Buat DataSet untuk komunitas ini
    const commNodes = new vis.DataSet(communityNodes.map(node => {
      const numCommunities = node.communities.length;
      const nodeSize = 25 + (numCommunities * 4);
      
      const communitiesList = node.communities.join(', ');
      const nodeTitle = `${node.label}\nCommunities: ${communitiesList}`;
      
      return {
        id: node.id,
        label: node.label,
        title: nodeTitle,
        shape: 'custom',
        size: nodeSize,
        communities: node.communities,
        ctxRenderer: function(params) {
          const {ctx, x, y, state, style} = params;
          
          const result = renderNode(ctx, x, y, {
            size: style.size,
            label: node.label,
            communities: node.communities
          });
          
          // Highlight jika dipilih atau hover
          if (state.selected || state.hover) {
            ctx.strokeStyle = state.selected ? '#FF0000' : '#666666';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x, y, style.size + 3, 0, 2 * Math.PI);
            ctx.stroke();
          }
          
          return result;
        },
        font: {
          size: 10,
          color: '#000'
        }
      };
    }));

    const commEdges = new vis.DataSet(communityEdges.map(edge => ({
      from: edge.from,
      to: edge.to,
      color: {
        color: '#1566c1',
        highlight: '#000000'
      },
      width: 3
    })));

    // Konfigurasi untuk komunitas network
    const options = {
      physics: {
        enabled: true,
        stabilization: {
          iterations: 300,
          updateInterval: 50
        },
        barnesHut: {
          gravitationalConstant: -5000,
          centralGravity: 0.05,
          springLength: 300,
          springConstant: 0.015,
          damping: 0.9,
          avoidOverlap: 1
        }
      },
      nodes: {
        shape: 'dot',
        size: 25,
        borderWidth: 2,
        font: {
          size: 12,
          face: 'Arial',
          align: 'center',
          vadjust: 0
        }
      },
      edges: {
        width: 1.5,
        color: {
          color: '#999999',
          opacity: 0.3
        },
        smooth: {
          type: 'continuous'
        }
      },
      interaction: {
        hover: true,
        zoomView: true,
        dragView: true
      },
      configure: false
    };

    // Render network
    const data = { nodes: commNodes, edges: commEdges };
    communityNetworks[communityId] = new vis.Network(container, data, options);
    
    console.log(`Community ${communityId}: ${commNodes.length} nodes, ${commEdges.length} edges`);
    
    // Stabilization callback: disable physics setelah stabil
    communityNetworks[communityId].on("stabilizationIterationsDone", function() {
      console.log(`Community ${communityId} stabilization done`);
      communityNetworks[communityId].setOptions({ physics: { enabled: false } });
      communityNetworks[communityId].fit();
    });
    
    // Debug render
    communityNetworks[communityId].on("afterDrawing", function() {
      try {
        const net = communityNetworks[communityId];
        if (net && typeof net.getVisibleNodes === 'function') {
          console.log(`Community ${communityId} drawn, visible nodes:`, net.getVisibleNodes().length);
        } else {
          console.log(`Community ${communityId} drawn`);
        }
      } catch (e) {
        console.log(`Community ${communityId} drawn (debug error ignored):`, e);
      }
    });
  }
</script>
{% endif %} 
{% endblock %}
